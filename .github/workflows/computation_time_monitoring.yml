name: Computation Time Monitoring

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
  push:
    branches:
      - '**'

jobs:
  speed-monitor:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [ '3.11' ]

    steps:
      - name: Set notebook list
        run: |
          echo "NOTEBOOKS=aeromaps/notebooks/tutorials/run_a_basic_calculation/examples_basic.ipynb aeromaps/notebooks/publications/tsas_2025/examples_tsas_application.ipynb" >> $GITHUB_ENV

      - name: Checkout current branch
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: pipx install poetry

      - name: Install dependencies
        run: |
          poetry env use ${{ matrix.python-version }}
          poetry install

      - name: Save current branch name
        id: branch
        run: echo "BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_ENV

      - name: Run notebooks on current branch
        run: |
          mkdir -p /tmp/timings
          for nb in $NOTEBOOKS; do
            echo "Timing $nb on $BRANCH_NAME"
            start=$(date +%s)
            poetry run jupyter nbconvert --to notebook --execute --inplace "$nb"
            end=$(date +%s)
            echo "$((end - start))" > /tmp/timings/$(basename $nb).$BRANCH_NAME.time
          done

      - name: Stash notebook changes
        run: git stash push -u -m "Stash before switching branches"

      - name: Checkout main branch
        run: |
          git fetch origin main:main
          git checkout main

      - name: Install dependencies (main)
        run: |
          poetry env use ${{ matrix.python-version }}
          poetry install

      - name: Run notebooks on main branch
        run: |
          mkdir -p /tmp/timings
          for nb in $NOTEBOOKS; do
            echo "Timing $nb on main"
            start=$(date +%s)
            poetry run jupyter nbconvert --to notebook --execute --inplace "$nb"
            end=$(date +%s)
            echo "$((end - start))" > /tmp/timings/$(basename $nb).main.time
          done

      - name: Compare timings
        run: |
          echo "Notebook timing comparison:"
          fail=0
          {
            echo "| Notebook | main (s) | $BRANCH_NAME (s) | diff (s) | diff (%) |"
            echo "|----------|----------|----------------|----------|----------|"
            for nb in $NOTEBOOKS; do
              base=$(basename $nb)
              t_main=$(cat /tmp/timings/$base.main.time)
              t_branch=$(cat /tmp/timings/$base.$BRANCH_NAME.time)
              diff=$((t_branch-t_main))
              # Calculate percent difference (avoid division by zero)
              if [ "$t_main" -eq 0 ]; then
                percent=0
              else
                percent=$(awk -v t_main="$t_main" -v t_branch="$t_branch" 'BEGIN { printf "%.2f", (t_branch-t_main)/t_main*100 }')
              fi
              echo "$base: main=${t_main}s, $BRANCH_NAME=${t_branch}s, diff=${diff}s, diff=${percent}%"
              echo "| $base | $t_main | $t_branch | $diff | $percent |"
              # Fail if percent difference > 1%
              abs_percent=$(awk -v p="$percent" 'BEGIN { print (p<0)?-p:p }')
              awk -v a="$abs_percent" 'BEGIN { exit (a > 1.0) ? 1 : 0 }' || fail=1
            done
          } | tee -a $GITHUB_STEP_SUMMARY
          exit $fail

      - name: Restore branch
        if: always()
        run: |
          git checkout $BRANCH_NAME
          git stash pop || true